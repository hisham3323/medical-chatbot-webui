<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Chatbot</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #f4f4f4; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px 0; }
        #auth-container { background-color: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); width: 100%; max-width: 450px; text-align: center; }
        #auth-container h2 { margin-top: 0; margin-bottom: 20px; color: #333; }
        .auth-form input[type="text"], .auth-form input[type="email"], .auth-form input[type="password"], .auth-form input[type="number"] { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .auth-form button { width: 100%; padding: 12px; border: none; border-radius: 4px; background-color: #007bff; color: white; font-size: 16px; cursor: pointer; margin-bottom: 15px; }
        .auth-form button:disabled { background-color: #a0cffa; cursor: not-allowed; }
        .split-row { display: flex; gap: 15px; }
        .checkbox-group { text-align: left; margin-bottom: 15px; display: flex; gap: 20px; justify-content: center; }
        .checkbox-group label { display: flex; align-items: center; gap: 5px; }
        #mode-toggle { color: #007bff; cursor: pointer; text-decoration: none; }
        #mode-toggle:hover { text-decoration: underline; }
        #chat-container { width: 100%; max-width: 600px; height: 80vh; background-color: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; overflow: hidden; }
        .chat-window { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 80%; padding: 10px 15px; border-radius: 20px; word-wrap: break-word; }
        .user-message { background-color: #007bff; color: white; align-self: flex-end; border-bottom-right-radius: 5px; }
        .bot-message { background-color: #e9ecef; color: #333; align-self: flex-start; border-bottom-left-radius: 5px; }
        .input-container { display: flex; padding: 10px; border-top: 1px solid #ccc; }
        .input-container input { flex-grow: 1; border: 1px solid #ddd; padding: 10px; border-radius: 20px; outline: none; }
        .input-container button { border: none; background-color: #007bff; color: white; padding: 10px 15px; margin-left: 10px; border-radius: 20px; cursor: pointer; outline: none; }
        .input-container button:disabled { background-color: #a0cffa; cursor: not-allowed; }
    </style>
</head>
<body>
    <div id="auth-container">
        <h2 id="auth-title">Medical Assistant Login</h2>
        <form id="auth-form" class="auth-form">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Password" required>
            
            <div id="medical-fields" style="display: none;">
                <input type="text" id="name" placeholder="Full Name">
                <div class="split-row">
                    <input type="number" id="age" placeholder="Age">
                    <input type="text" id="gender" placeholder="Gender">
                </div>
                <div class="split-row">
                    <input type="number" id="weight" placeholder="Weight (kg)">
                    <input type="number" id="height" placeholder="Height (cm)">
                </div>
                <input type="text" id="conditions" placeholder="Current symptoms (comma-separated)">
                <div class="checkbox-group">
                    <label><input type="checkbox" id="diabetes"> Diabetes</label>
                    <label><input type="checkbox" id="hypertension"> Hypertension</label>
                </div>
            </div>
            
            <button type="submit" id="auth-button">Login</button>
            <a href="#" id="mode-toggle">Don't have an account? Sign Up</a>
        </form>
    </div>

    <div id="chat-container" style="display: none;">
        <div class="chat-window" id="chat-window"></div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Type your message...">
            <button id="send-btn">Send</button>
        </div>
    </div>
    
    <script>
        // --- SELECTORS ---
        const authContainer = document.getElementById('auth-container');
        const chatContainer = document.getElementById('chat-container');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const authButton = document.getElementById('auth-button');
        const medicalFields = document.getElementById('medical-fields');
        const nameInput = document.getElementById('name');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const ageInput = document.getElementById('age');
        const genderInput = document.getElementById('gender');
        const weightInput = document.getElementById('weight');
        const heightInput = document.getElementById('height');
        const conditionsInput = document.getElementById('conditions');
        const diabetesInput = document.getElementById('diabetes');
        const hypertensionInput = document.getElementById('hypertension');
        const modeToggle = document.getElementById('mode-toggle');
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        // --- SUPABASE CLIENT ---
        const supabaseUrl = 'https://hsniboswprhxvvbbejok.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhzbmlib3N3cHJoeHZ2YmJlam9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5OTg4MDgsImV4cCI6MjA3MTU3NDgwOH0.Cg2pB6udSPvAn9w05IifOn_XRr06HEBSgyLgSPFPyDo';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        // --- AUTH LOGIC ---
        let USER_ID = null;
        let isLoginMode = true;

        modeToggle.addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            updateAuthUI();
        });

        function updateAuthUI() {
            if (isLoginMode) {
                authTitle.textContent = 'Medical Assistant Login';
                authButton.textContent = 'Login';
                medicalFields.style.display = 'none';
                nameInput.required = false;
                modeToggle.textContent = "Don't have an account? Sign Up";
            } else {
                authTitle.textContent = 'Create an Account';
                authButton.textContent = 'Sign Up';
                medicalFields.style.display = 'block';
                nameInput.required = true;
                modeToggle.textContent = 'Already have an account? Login';
            }
        }

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authButton.disabled = true;
            authButton.textContent = 'Processing...';
            try {
                if (isLoginMode) {
                    await handleLogin();
                } else {
                    await handleSignup();
                }
            } finally {
                authButton.disabled = false;
                updateAuthUI();
            }
        });

        async function handleLogin() { /* ... same as before ... */ }

        async function handleSignup() {
            try {
                const conditions = conditionsInput.value.split(',').map(s => s.trim()).filter(s => s);
                const response = await fetch('http://127.0.0.1:5000/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: emailInput.value,
                        password: passwordInput.value,
                        name: nameInput.value,
                        age: parseInt(ageInput.value) || null,
                        gender: genderInput.value || null,
                        weight: parseFloat(weightInput.value) || null,
                        height: parseFloat(heightInput.value) || null,
                        diabetes: diabetesInput.checked,
                        hypertension: hypertensionInput.checked,
                        conditions: conditions
                    })
                });
                const result = await response.json();
                if (!response.ok) { throw new Error(result.detail || 'Signup failed.'); }
                alert(result.message);
                isLoginMode = true;
                updateAuthUI();
            } catch (error) {
                alert('Signup Error: ' + error.message);
            }
        }
        
        async function handleLogin() {
            const { data, error } = await supabase.auth.signInWithPassword({
                email: emailInput.value,
                password: passwordInput.value,
            });
            if (error) {
                alert('Login failed: ' + error.message);
            } else if (data.user) {
                USER_ID = data.user.id;
                authContainer.style.display = 'none';
                chatContainer.style.display = 'flex';
                // Add welcome message
                chatWindow.innerHTML = ''; // Clear previous messages
                addMessage(`Welcome back! How can I help you today?`, 'bot');
            }
        }

        // --- CHAT LOGIC ---
        function addMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
            messageDiv.textContent = message;
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        async function sendMessage() {
            const messageText = userInput.value.trim();
            if (!messageText || !USER_ID) return;
            addMessage(messageText, 'user');
            userInput.value = '';
            sendBtn.disabled = true;
            userInput.disabled = true;
            try {
                const response = await fetch('http://127.0.0.1:5000/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uid: USER_ID, message: messageText })
                });
                if (!response.ok) throw new Error('Network response was not ok.');
                const data = await response.json();
                addMessage(data.reply, 'bot');
            } catch (error) {
                addMessage('Sorry, something went wrong. Please try again.', 'bot');
            } finally {
                sendBtn.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }
        
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>